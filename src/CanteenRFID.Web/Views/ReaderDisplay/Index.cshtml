@model CanteenRFID.Web.Models.ReaderDisplayViewModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CanteenRFID Reader Display</title>
    <style>
        :root {
            color-scheme: only dark;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at top, rgba(59, 130, 246, 0.22), transparent 55%),
                radial-gradient(circle at bottom, rgba(34, 197, 94, 0.22), transparent 60%),
                #0b1020;
            color: #f8fafc;
            min-height: 100vh;
        }
        .reader-display {
            min-height: 100vh;
            display: flex;
            align-items: stretch;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .reader-display::before,
        .reader-display::after {
            content: "";
            position: absolute;
            width: 420px;
            height: 420px;
            border-radius: 50%;
            filter: blur(90px);
            opacity: 0.45;
            z-index: 0;
        }
        .reader-display::before {
            top: -140px;
            left: -140px;
            background: rgba(59, 130, 246, 0.6);
        }
        .reader-display::after {
            bottom: -180px;
            right: -180px;
            background: rgba(34, 197, 94, 0.6);
        }
        .setup-panel {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        .setup-card {
            max-width: 560px;
            width: 100%;
            background: #111827;
            border-radius: 28px;
            padding: 3rem;
            box-shadow: 0 24px 70px rgba(15, 23, 42, 0.6);
        }
        .setup-card h1 {
            margin-top: 0;
            font-size: clamp(1.8rem, 3vw, 2.4rem);
        }
        .form-label {
            display: block;
            margin-top: 1.4rem;
            font-weight: 600;
        }
        .form-select {
            width: 100%;
            margin-top: 0.6rem;
            padding: 0.9rem 1rem;
            border-radius: 14px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #f8fafc;
            font-size: 1.05rem;
        }
        .form-button {
            margin-top: 1.8rem;
            width: 100%;
            padding: 1rem;
            border-radius: 14px;
            border: none;
            background: #22c55e;
            color: #0f172a;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
        }
        .status-panel {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .status-hint {
            font-size: clamp(2rem, 4vw, 3rem);
            opacity: 0.6;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .stamp-card {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #0b1020;
            border-radius: 36px;
            padding: clamp(2.4rem, 4vw, 4.6rem);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: min(92vw, 980px);
            box-shadow: 0 45px 90px rgba(34, 197, 94, 0.35);
            transform: scale(0.95);
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .stamp-card.visible {
            opacity: 1;
            transform: scale(1);
        }
        .meal-label {
            font-size: clamp(3.2rem, 8vw, 6.2rem);
            font-weight: 800;
        }
        .user-name {
            font-size: clamp(1.6rem, 4vw, 3rem);
            font-weight: 600;
        }
        .checkmark {
            font-size: clamp(3.2rem, 8vw, 5.8rem);
        }
        .stamp-subtitle {
            font-size: clamp(1.2rem, 3vw, 2rem);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <main class="reader-display">
        <section id="setupPanel" class="setup-panel">
            <div class="setup-card">
                <h1>Reader auswählen</h1>
                <p>Bitte wählen Sie den Reader, der an dieser Kasse verwendet wird.</p>
                <form id="setupForm">
                    <label class="form-label" for="readerSelect">Reader</label>
                    <select id="readerSelect" class="form-select" required>
                        <option value="">Bitte wählen...</option>
                        @foreach (var reader in Model.Readers)
                        {
                            var name = string.IsNullOrWhiteSpace(reader.Location)
                                ? reader.DisplayName
                                : $"{reader.DisplayName} ({reader.Location})";
                            var label = reader.IsActive ? name : $"{name} (inaktiv)";
                            <option value="@reader.ReaderId">@label</option>
                        }
                    </select>
                    <button class="form-button" type="submit">Starten</button>
                </form>
            </div>
        </section>

        <section id="statusPanel" class="status-panel hidden">
            <div class="status-hint">Bitte RFID vorhalten</div>
            <div id="stampCard" class="stamp-card hidden">
                <div id="mealLabel" class="meal-label">Frühstück</div>
                <div id="userName" class="user-name"></div>
                <div class="checkmark" aria-hidden="true">✔</div>
                <div class="stamp-subtitle">Stempelung erfasst</div>
            </div>
        </section>
    </main>

    <script>
        const storageKey = 'canteenReaderId';
        const initialReaderId = '@(Model.SelectedReaderId ?? string.Empty)';
        const setupPanel = document.getElementById('setupPanel');
        const statusPanel = document.getElementById('statusPanel');
        const stampCard = document.getElementById('stampCard');
        const mealLabel = document.getElementById('mealLabel');
        const userName = document.getElementById('userName');
        const setupForm = document.getElementById('setupForm');
        const readerSelect = document.getElementById('readerSelect');
        const hintText = document.querySelector('.status-hint');

        let lastStampTimestamp = null;
        let hideTimer = null;
        let pollInterval = null;

        const showStamp = (stamp) => {
            if (hideTimer) {
                clearTimeout(hideTimer);
            }
            mealLabel.textContent = stamp.mealLabel || stamp.mealType || 'Unbekannt';
            userName.textContent = stamp.userName || '';
            stampCard.classList.remove('hidden');
            stampCard.classList.add('visible');
            hintText.textContent = 'Buchung erfasst';

            hideTimer = setTimeout(() => {
                stampCard.classList.remove('visible');
                stampCard.classList.add('hidden');
                hintText.textContent = 'Bitte RFID vorhalten';
            }, 5000);
        };

        const fetchLatestStamp = async (readerId) => {
            const params = lastStampTimestamp ? `?since=${encodeURIComponent(lastStampTimestamp)}` : '';
            const response = await fetch(`/api/v1/readers/${encodeURIComponent(readerId)}/latest-stamp-display${params}`);
            if (response.status === 204) {
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        };

        const startPolling = (readerId) => {
            setupPanel.classList.add('hidden');
            statusPanel.classList.remove('hidden');
            hintText.textContent = 'Bitte RFID vorhalten';

            const poll = async () => {
                try {
                    const stamp = await fetchLatestStamp(readerId);
                    if (stamp) {
                        lastStampTimestamp = stamp.timestampUtc || stamp.TimestampUtc;
                        showStamp({
                            mealLabel: stamp.mealLabel || stamp.MealLabel,
                            mealType: stamp.mealType || stamp.MealType,
                            userName: stamp.userName || stamp.UserName
                        });
                    }
                } catch (error) {
                    hintText.textContent = 'Verbindung zum Server fehlgeschlagen';
                }
            };

            poll();
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            pollInterval = setInterval(poll, 1200);
        };

        setupForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const readerId = readerSelect.value;
            if (!readerId) {
                return;
            }
            localStorage.setItem(storageKey, readerId);
            startPolling(readerId);
        });

        if (initialReaderId) {
            readerSelect.value = initialReaderId;
            if (readerSelect.value) {
                startPolling(initialReaderId);
            }
        } else {
            const storedReaderId = localStorage.getItem(storageKey);
            if (storedReaderId) {
                readerSelect.value = storedReaderId;
                if (readerSelect.value) {
                    startPolling(storedReaderId);
                }
            }
        }
    </script>
</body>
</html>
