@model IEnumerable<CanteenRFID.Core.Models.Stamp>
@using CanteenRFID.Core.Enums
@{
    ViewData["Title"] = "Stempelungen";
    var canDelete = User.IsInRole("Admin");
    string MealLabel(MealType meal) => meal switch
    {
        MealType.Breakfast => "Frühstück",
        MealType.Lunch => "Mittagessen",
        MealType.Dinner => "Abendessen",
        _ => "Unbekannt"
    };
}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Stempelungen</h2>
    <div class="text-muted small">Letzte Aktualisierung: <span id="last-refresh">-</span></div>
</div>
@if (TempData["Info"] != null)
{
    <div class="alert alert-success">@TempData["Info"]</div>
}
<form class="row gy-2 align-items-end mb-3" id="filter-form">
    <div class="col-md-2">
        <label class="form-label">Von</label>
        <input type="datetime-local" class="form-control" name="from" />
    </div>
    <div class="col-md-2">
        <label class="form-label">Bis</label>
        <input type="datetime-local" class="form-control" name="to" />
    </div>
    <div class="col-md-2">
        <label class="form-label">Benutzer / UID / Reader</label>
        <input class="form-control" name="search" placeholder="Suchen" />
    </div>
    <div class="col-md-2">
        <label class="form-label">Meal Type</label>
        <select class="form-select" name="mealType">
            <option value="">Alle</option>
            @foreach (MealType m in ViewBag.MealTypes)
            {
                <option value="@m">@m</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">Reader</label>
        <input class="form-control" name="readerId" placeholder="READER-01" />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary" type="submit">Filtern</button>
        <button class="btn btn-link" type="button" id="btn-clear">Reset</button>
    </div>
</form>
<div id="stamps-alert" class="d-none"></div>
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="stamps-table" data-can-delete="@canDelete.ToString().ToLower()">
        <thead class="table-light">
            <tr>
                <th>Zeit (UTC)</th>
                <th>Lokale Zeit</th>
                <th>UID</th>
                <th>Person</th>
                <th>Reader</th>
                <th>Meal</th>
                <th class="text-end">Aktionen</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var s in Model)
        {
            <tr class="@(s.User == null ? "table-warning" : "")" data-id="@s.Id">
                <td>@s.TimestampUtc.ToString("dd.MM.yyyy HH:mm:ss")</td>
                <td>@s.TimestampLocal.ToString("dd.MM.yyyy HH:mm:ss")</td>
                <td>@s.UidRaw</td>
                <td>@(s.UserDisplayName ?? s.User?.FullName ?? "Unbekannt")</td>
                <td>@s.ReaderId</td>
                <td>@MealLabel(s.MealType)</td>
                <td class="text-end">
                    @if (s.User == null)
                    {
                        <a class="btn btn-sm btn-outline-primary" href="/Users?search=@s.UidRaw">Benutzer verknüpfen</a>
                    }
                    @if (canDelete)
                    {
                        <form method="post" asp-action="Delete" asp-route-id="@s.Id" class="d-inline" onsubmit="return confirm('Löschen?');">
                            <button class="btn btn-sm btn-danger" type="submit">Löschen</button>
                        </form>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<form id="stamps-antiforgery" method="post" class="d-none">
    @Html.AntiForgeryToken()
</form>

<script src="~/js/stamps.js"></script>
